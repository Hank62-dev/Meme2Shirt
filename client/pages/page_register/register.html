<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="./auth.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    />

    <title>MemeShirt.vn - Register</title>
    <link
      rel="icon"
      type="image/png"
      href="../../assets/img/logo/logoMemeShirt.png"
    />
  </head>
  <body>
    <div class="container">
      <!-- Cột trái -->
      <div class="col left">
        <div class="left register_frame">
          <div class="boxTitle">
            <h1>Registration</h1>
          </div>
          <div class="boxUsername">
            <input id="username" placeholder="Username" type="text" required />
          </div>
          <div class="boxEmail">
            <input id="email" placeholder="Email" type="email" required />
          </div>
          <div class="boxPassword">
            <input
              id="password"
              placeholder="Password"
              type="password"
              required
            />
          </div>
          <div class="boxConfirm">
            <button id="btn_register">Register</button>
          </div>
          <div class="socialLoginBox">or login with social platforms</div>
          <div class="socialIcon">
            <i class="fa-brands fa-google"></i>
            <i class="fa-brands fa-facebook-f"></i>
            <i class="fa-brands fa-github"></i>
            <i class="fa-brands fa-linkedin-in"></i>
          </div>
        </div>
      </div>

      <!-- Cột phải -->
      <div class="col right">
        <div class="right_frame">
          <div class="right intro">
            <h1>Welcome Back!</h1>
          </div>
          <div class="right prompt_to_login">
            <p>Already have an account?</p>
          </div>
          <div class="right loginBox">
            <div class="loginBox login_button">
              <button id="login">Login</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      <script>
      // --- 1. PHẦN ANIMATION & LOGIN (GIỮ NGUYÊN CỦA BẠN) ---
      window.addEventListener("load", () => {
        setTimeout(() => {
          document.querySelector(".right_frame").classList.add("show");
          document.querySelector(".register_frame").classList.add("show");
        }, 500);
      });

      document.getElementById("login").addEventListener("click", function () {
        document.querySelector(".right").classList.add("element_slide_out");
        document.querySelector(".left").classList.add("fade_out");

        document.querySelector(".right_frame").classList.remove("show");
        document.querySelector(".register_frame").classList.remove("show");
        setTimeout(function () {
          document.querySelector(".container").classList.add("right_expand");
        }, 1200);

        setTimeout(function () {
          document.querySelector(".container").classList.remove("right_expand");
          document
            .querySelector(".container")
            .classList.add("prepare_move_to_login");
        }, 2800);

        setTimeout(function () {
          document
            .querySelector(".container")
            .classList.remove("prepare_move_to_login");
          document.querySelector(".container").classList.add("pink_slide_out");
        }, 3000);

        setTimeout(() => {
          window.location.href = "../page_login/login.html";
        }, 4500);
      });

      // --- 2. LOGIC REGISTER (SỬA THEO CHUẨN CHECKOUT) ---
      document
        .getElementById("btn_register")
        .addEventListener("click", async function (e) {
          e.preventDefault();

          // Danh sách các ID cần kiểm tra
          const fieldsToCheck = ["username", "email", "password"];
          let isValid = true; // Cờ kiểm tra tổng

          // Vòng lặp kiểm tra từng ô input
          fieldsToCheck.forEach((fieldId) => {
            const element = document.getElementById(fieldId);
            if (!element) return;

            const val = element.value.trim();
            let isFieldValid = true;
            let errorMessage = "";

            // A. Kiểm tra Rỗng (Empty)
            if (!val) {
              isFieldValid = false;
              // Viết hoa chữ cái đầu: username -> Username
              const fieldName =
                fieldId.charAt(0).toUpperCase() + fieldId.slice(1);
              errorMessage = `${fieldName} mustn't be empty`;
            }
            // B. Kiểm tra riêng cho Email (nếu không rỗng)
            else if (fieldId === "email") {
              const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
              if (!emailRegex.test(val)) {
                isFieldValid = false;
                errorMessage = "Email invalid";
              }
            }

            // C. Xử lý hiển thị lỗi (Giống mẫu Checkout)
            if (!isFieldValid) {
              isValid = false;
              element.classList.add("input-error"); // Thêm viền đỏ
              element.value = ""; // Xóa nội dung sai
              element.placeholder = errorMessage; // Hiện lỗi vào placeholder
            } else {
              // Nếu đúng thì xóa lỗi
              element.classList.remove("input-error");
            }
          });

          // Nếu TẤT CẢ hợp lệ thì mới gửi dữ liệu đi
          if (isValid) {
            // Lấy lại giá trị chính xác lần nữa để gửi
            const username = document.getElementById("username").value.trim();
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value;

            try {
              const response = await fetch("/register", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ username, email, password }),
              });

              const result = await response.json();
              console.log("Response:", result);

              if (response.ok) {
                alert(result.message);
                // Chuyển hướng
                setTimeout(() => {
                  window.location.href = "../page_login/login.html";
                }, 1000);
              } else {
                alert(result.message || "Registration failed");
              }
            } catch (error) {
              console.error("Error:", error);
              alert("An error occurred during registration");
            }
          }
        });

      // --- 3. SỰ KIỆN FOCUS ĐỂ XÓA LỖI ---
      // Khi bấm vào ô input đang đỏ, nó sẽ mất màu đỏ đi
      const inputs = document.querySelectorAll("input");
      inputs.forEach((input) => {
        input.addEventListener("focus", function () {
          this.classList.remove("input-error");
        });
      });
    </script>
    </script>
  </body>
</html>
